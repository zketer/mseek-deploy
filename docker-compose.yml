services:
  # ================================
  # MySQL 数据库 - 可选启用
  # 如果使用外部MySQL，可以不启动此服务
  # ================================
  mysql:
    image: mysql:8.0
    container_name: mseek-mysql
    restart: always
    profiles: ["mysql-local"]  # 通过profile控制是否启动
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_general_ci
    volumes:
      - ./services/common/mysql/data:/var/lib/mysql
      - ./services/common/mysql/init:/docker-entrypoint-initdb.d
      - ./services/common/mysql/conf:/etc/mysql/conf.d
    command: --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=256M --max-connections=200
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: ${MYSQL_MEMORY_LIMIT:-400M}
        reservations:
          memory: ${MYSQL_MEMORY_RESERVATION:-200M}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ================================
  # API 网关服务 - 始终启用
  # ================================
  gateway-service:
    image: openjdk:17
    container_name: mseek-gateway
    restart: always
    ports:
      - "${GATEWAY_PORT:-8000}:8000"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM内存优化参数
      JAVA_OPTS: >-
        -server
        -Xmx${GATEWAY_JVM_XMX:-300m} -Xms${GATEWAY_JVM_XMS:-150m}
        -XX:MetaspaceSize=80m -XX:MaxMetaspaceSize=128m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseContainerSupport
        -XX:+UseStringDeduplication
        -Djava.security.egd=file:/dev/./urandom
      # Nacos配置（外部）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE}
      NACOS_GROUP: ${NACOS_GROUP}
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
      # Redis配置（外部）
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # 日志配置
    working_dir: /app
    command: ["./bin/start.sh"]
    volumes:
      - ./services/business/gateway-service:/app
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 400M
        reservations:
          memory: 200M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ================================
  # 认证服务 - 始终启用
  # ================================
  auth-service:
    image: openjdk:17
    container_name: mseek-auth
    restart: always
    ports:
      - "${AUTH_PORT:-8001}:8001"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM内存优化参数
      JAVA_OPTS: >-
        -server
        -Xmx${AUTH_JVM_XMX:-320m} -Xms${AUTH_JVM_XMS:-160m}
        -XX:MetaspaceSize=80m -XX:MaxMetaspaceSize=128m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseContainerSupport
        -XX:+UseStringDeduplication
        -Djava.security.egd=file:/dev/./urandom
      # Nacos配置（外部）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE}
      NACOS_GROUP: ${NACOS_GROUP}
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
      # Redis配置（外部）
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # 数据库配置（可以是外部或本地）
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # JWT配��
      JWT_RSA_PRIVATE_KEY: ${JWT_RSA_PRIVATE_KEY}
      JWT_RSA_PUBLIC_KEY: ${JWT_RSA_PUBLIC_KEY}
      JWT_RSA_KEY_ID: ${JWT_RSA_KEY_ID}
      # 微信小程序配置
      WECHAT_MINIPROGRAM_APPID: ${WECHAT_MINIPROGRAM_APPID}
      WECHAT_MINIPROGRAM_SECRET: ${WECHAT_MINIPROGRAM_SECRET}
      # 邮件配置
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT}
      MAIL_FROM: ${MAIL_FROM}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASS: ${MAIL_PASS}
      # 邮件SSL和SMTP配置（解决163邮箱认证问题）
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_AUTH: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_ENABLE: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_STARTTLS_REQUIRED: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_SSL_ENABLE: "true"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_SOCKETFACTORY_PORT: "465"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_SOCKETFACTORY_CLASS: "javax.net.ssl.SSLSocketFactory"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_SOCKETFACTORY_FALLBACK: "false"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_TIMEOUT: "5000"
      SPRING_MAIL_PROPERTIES_MAIL_SMTP_CONNECTIONTIMEOUT: "5000"
      # 日志配置
    working_dir: /app
    command: ["./bin/start.sh"]
    volumes:
      - ./services/business/auth-service:/app
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 450M
        reservations:
          memory: 200M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/v1/auth/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ================================
  # 用户服务 - 始终启用
  # ================================
  user-service:
    image: openjdk:17
    container_name: mseek-user
    restart: always
    ports:
      - "${USER_PORT:-8002}:8002"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM内存优化参数
      JAVA_OPTS: >-
        -server
        -Xmx${USER_JVM_XMX:-320m} -Xms${USER_JVM_XMS:-160m}
        -XX:MetaspaceSize=80m -XX:MaxMetaspaceSize=128m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseContainerSupport
        -XX:+UseStringDeduplication
        -Djava.security.egd=file:/dev/./urandom
      # Nacos配置（外部）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE}
      NACOS_GROUP: ${NACOS_GROUP}
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
       # Redis配置（外部） 
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # 数据库配置
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # 日志配置
    working_dir: /app
    command: ["./bin/start.sh"]
    volumes:
      - ./services/business/user-service:/app
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 450M
        reservations:
          memory: 200M
    depends_on:
      - auth-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/api/v1/system/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ================================
  # 博物馆服务 - 始终启用
  # ================================
  museum-service:
    image: openjdk:17
    container_name: mseek-museum
    restart: always
    ports:
      - "${MUSEUM_PORT:-8003}:8003"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM内存优化参数
      JAVA_OPTS: >-
        -server
        -Xmx${MUSEUM_JVM_XMX:-550m} -Xms${MUSEUM_JVM_XMS:-275m}
        -XX:MetaspaceSize=120m -XX:MaxMetaspaceSize=200m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseContainerSupport
        -XX:+UseStringDeduplication
        -Djava.security.egd=file:/dev/./urandom
      # Nacos配置（外部）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE}
      NACOS_GROUP: ${NACOS_GROUP}
      
      # # Redis配置（外部）
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # 数据库配置
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # 邮件配置
      MAIL_HOST: ${MAIL_HOST}
      MAIL_PORT: ${MAIL_PORT:-465}
      MAIL_FROM: ${MAIL_FROM}
      MAIL_USER: ${MAIL_USER}
      MAIL_PASS: ${MAIL_PASS}
      # 高德地图配置
      AMAP_KEY: ${AMAP_KEY}
      # 日志配置
    working_dir: /app
    command: ["./bin/start.sh"]
    volumes:
      - ./services/business/museum-service:/app
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 700M
        reservations:
          memory: 350M
    depends_on:
      - auth-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/api/v1/museums/actuator/health"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 60s

  # ================================
  # 文件服务 - 始终启用
  # 使用外部MinIO
  # ================================
  file-service:
    image: openjdk:17
    container_name: mseek-file
    restart: always
    ports:
      - "${FILE_PORT:-8004}:8004"
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      # JVM内存优化参数
      JAVA_OPTS: >-
        -server
        -Xmx${FILE_JVM_XMX:-180m} -Xms${FILE_JVM_XMS:-90m}
        -XX:MetaspaceSize=96m -XX:MaxMetaspaceSize=160m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+UseContainerSupport
        -XX:+UseStringDeduplication
        -Djava.security.egd=file:/dev/./urandom
      # Nacos配置（外部）
      NACOS_SERVER_ADDR: ${NACOS_SERVER_ADDR}
      NACOS_NAMESPACE: ${NACOS_NAMESPACE}
      NACOS_GROUP: ${NACOS_GROUP}
      NACOS_USERNAME: ${NACOS_USERNAME}
      NACOS_PASSWORD: ${NACOS_PASSWORD}
      # Redis配置（外部）
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE: ${REDIS_DATABASE}
      # 数据库配置
      MYSQL_HOST: ${MYSQL_HOST}
      MYSQL_PORT: ${MYSQL_PORT:-3306}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      # 存储配置（支持MinIO和OSS）
      STORAGE_TYPE: ${STORAGE_TYPE:-oss}
      BUCKET_NAME: ${BUCKET_NAME:-mseek}

      # MinIO配置
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      # MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-mseek}
      MINIO_REGION: ${MINIO_REGION:-us-east-1}
      # OSS配置
      OSS_ENDPOINT: ${OSS_ENDPOINT}
      OSS_ACCESS_KEY_ID: ${OSS_ACCESS_KEY_ID}
      OSS_ACCESS_KEY_SECRET: ${OSS_ACCESS_KEY_SECRET}
      # OSS_BUCKET_NAME: ${OSS_BUCKET_NAME:-mseek}
      OSS_REGION: ${OSS_REGION:-cn-beijing}
      # 日志配置
    working_dir: /app
    command: ["./bin/start.sh"]
    volumes:
      - ./services/business/file-service:/app
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 320M
        reservations:
          memory: 150M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/api/v1/files/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ================================
  # Nginx 前端服务 - 始终启用
  # ================================
  nginx:
    image: nginx:alpine
    container_name: mseek-nginx
    restart: always
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    volumes:
      - ./services/common/nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./services/common/nginx/conf/default.conf:/etc/nginx/conf.d/default.conf
      - ./services/common/nginx/web:/opt/museum-frontend
      - ./services/common/nginx/cert:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    networks:
      - mseek-network
    deploy:
      resources:
        limits:
          memory: 50M
        reservations:
          memory: 20M
    depends_on:
      - gateway-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  mseek-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/16

# ================================
# 说明:
# 1. 此配置文件用于完全外部化部署（Redis、MinIO、Nacos均使用外部服务）
# 2. MySQL可通过 profile "mysql-local" 控制是否启动本地实例
# 3. 所有业务服务直接连接外部Redis、MinIO、Nacos
# 4. 需要在 prod-external-all.env 中配置外部服务地址
# 5. 资源占用：仅业务服务 + Nginx，约 2.5GB 内存
# ================================